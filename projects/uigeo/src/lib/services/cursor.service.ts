import {Injectable, signal} from '@angular/core';
import {auditTime, BehaviorSubject, combineLatest} from 'rxjs';

@Injectable({
  providedIn: 'root',
})
export class CursorService {
  private cursorStyleSignal = signal('');
  cursorStyle = this.cursorStyleSignal.asReadonly();

  private angle = new BehaviorSubject(0);
  private cursorSvgPath = new BehaviorSubject('');

  constructor() {
    combineLatest([this.cursorSvgPath, this.angle])
      .pipe(auditTime(10))
      .subscribe(([path, angle]) => {
        if (!path) {
          this.cursorStyleSignal.set('');

          return;
        }

        this.cursorStyleSignal.set(this.cursorSvgTemplate(path, angle));
      });
  }

  setCursor(type: CursorType, angle: number = 0): void {
    if (type === CursorType.Move) {
      this.setMoveCursor();

      return;
    }

    if (type === CursorType.Resize) {
      this.setResizeCursor(angle);

      return;
    }

    if (type === CursorType.Rotate) {
      this.setRotateCursor(angle);

      return;
    }

    this.cursorSvgPath.next('');
  }

  private setMoveCursor(): void {
    this.angle.next(0);
    this.cursorSvgPath.next(
      'M16.1006 7.50488C16.121 7.50696 16.1411 7.51133 16.1611 7.51465C16.1708 7.51626 16.1808 7.51666 16.1904 7.51855C16.205 7.52141 16.2191 7.52581 16.2334 7.5293C16.2517 7.53376 16.27 7.53841 16.2881 7.54395C16.304 7.54882 16.3194 7.5549 16.335 7.56055C16.3474 7.56504 16.3598 7.56921 16.3721 7.57422C16.3874 7.58048 16.4021 7.58773 16.417 7.59473C16.4609 7.61534 16.5038 7.63855 16.5449 7.66602C16.5989 7.70205 16.6496 7.74238 16.6953 7.78809L19.0869 10.1797C19.4709 10.5637 19.4709 11.1863 19.0869 11.5703C18.7029 11.9542 18.0802 11.9542 17.6963 11.5703L16.9834 10.8574V15.0166H21.1426L20.4297 14.3037C20.0458 13.9198 20.0458 13.2971 20.4297 12.9131L20.5049 12.8457C20.8654 12.5518 21.3857 12.5515 21.7461 12.8457L21.8203 12.9131L24.2119 15.3047C24.2574 15.3502 24.2981 15.4004 24.334 15.4541C24.3574 15.4891 24.378 15.5254 24.3965 15.5625C24.407 15.5836 24.4168 15.605 24.4258 15.627C24.4428 15.6685 24.4567 15.7108 24.4678 15.7539C24.4724 15.7717 24.4778 15.7894 24.4814 15.8076C24.4817 15.8089 24.4812 15.8103 24.4814 15.8115C24.4922 15.867 24.498 15.924 24.499 15.9824C24.4991 15.9883 24.5 15.9941 24.5 16C24.5 16.0522 24.4951 16.1033 24.4873 16.1533C24.4858 16.163 24.4852 16.1729 24.4834 16.1826C24.4802 16.1998 24.4748 16.2165 24.4707 16.2334C24.4662 16.2517 24.4616 16.27 24.4561 16.2881C24.4424 16.3327 24.4248 16.3754 24.4053 16.417C24.3847 16.4609 24.3615 16.5038 24.334 16.5449C24.2979 16.5989 24.2576 16.6496 24.2119 16.6953L21.8203 19.0869C21.4363 19.4709 20.8137 19.4709 20.4297 19.0869C20.0458 18.7029 20.0458 18.0802 20.4297 17.6963L21.1426 16.9834H16.9834V21.1426L17.6963 20.4297C18.0802 20.0458 18.7029 20.0458 19.0869 20.4297C19.4709 20.8137 19.4709 21.4363 19.0869 21.8203L16.6953 24.2119C16.6934 24.2138 16.6904 24.2149 16.6885 24.2168C16.6702 24.2348 16.6514 24.2521 16.6318 24.2686C16.6267 24.2729 16.6214 24.277 16.6162 24.2812C16.5291 24.3516 16.4301 24.4069 16.3223 24.4443C16.2844 24.4575 16.246 24.4682 16.207 24.4766C16.2011 24.4778 16.1954 24.4803 16.1895 24.4814C16.1765 24.484 16.1634 24.4853 16.1504 24.4873C16.1013 24.4948 16.0512 24.5 16 24.5L15.9023 24.4951C15.8842 24.4933 15.8664 24.4901 15.8486 24.4873C15.8356 24.4853 15.8225 24.484 15.8096 24.4814C15.8036 24.4803 15.7979 24.4778 15.792 24.4766C15.7531 24.4682 15.7146 24.4575 15.6768 24.4443C15.569 24.4068 15.4698 24.3516 15.3828 24.2812C15.3776 24.277 15.3723 24.2729 15.3672 24.2686C15.3476 24.252 15.3288 24.2348 15.3105 24.2168C15.3088 24.2151 15.3064 24.2137 15.3047 24.2119L12.9131 21.8203C12.5291 21.4363 12.5291 20.8137 12.9131 20.4297L12.9873 20.3623C13.3477 20.0682 13.868 20.0685 14.2285 20.3623L14.3037 20.4297L15.0166 21.1426V16.9834H10.8574L11.5703 17.6963C11.9542 18.0802 11.9542 18.7029 11.5703 19.0869C11.1863 19.4709 10.5637 19.4709 10.1797 19.0869L7.78809 16.6953C7.78616 16.6934 7.78511 16.6904 7.7832 16.6885C7.76524 16.6702 7.74795 16.6514 7.73145 16.6318C7.72711 16.6267 7.72297 16.6214 7.71875 16.6162C7.64775 16.5283 7.59119 16.4285 7.55371 16.3193C7.53479 16.2641 7.52151 16.2076 7.5127 16.1504C7.51001 16.1329 7.50664 16.1154 7.50488 16.0977L7.5 16C7.5 15.9941 7.50087 15.9883 7.50098 15.9824C7.50236 15.9035 7.51332 15.8272 7.53223 15.7539C7.54003 15.7236 7.54884 15.6936 7.55957 15.6641C7.59823 15.5578 7.65491 15.4605 7.72559 15.375C7.72766 15.3725 7.72935 15.3697 7.73145 15.3672C7.74795 15.3476 7.76524 15.3288 7.7832 15.3105C7.78495 15.3088 7.78633 15.3064 7.78809 15.3047L10.1797 12.9131L10.2539 12.8457C10.6143 12.5515 11.1346 12.5518 11.4951 12.8457L11.5703 12.9131L11.6377 12.9873C11.9529 13.3735 11.9303 13.9437 11.5703 14.3037L10.8574 15.0166H15.0166V10.8574L14.3037 11.5703C13.9198 11.9542 13.2971 11.9542 12.9131 11.5703C12.5291 11.1863 12.5291 10.5637 12.9131 10.1797L15.3047 7.78809C15.3502 7.74257 15.4004 7.70194 15.4541 7.66602C15.4952 7.63852 15.5381 7.61537 15.582 7.59473C15.5969 7.58771 15.6117 7.5805 15.627 7.57422C15.6392 7.5692 15.6517 7.56505 15.6641 7.56055C15.6796 7.55488 15.695 7.54883 15.7109 7.54395C15.729 7.5384 15.7473 7.53378 15.7656 7.5293C15.7799 7.5258 15.7941 7.52142 15.8086 7.51855C15.8183 7.51665 15.8282 7.51626 15.8379 7.51465C15.8907 7.50588 15.9447 7.5 16 7.5L16.1006 7.50488Z',
    );
  }

  private setResizeCursor(angle: number): void {
    this.angle.next(angle);
    this.cursorSvgPath.next(
      'M20.1246 8.10398C20.5802 8.55959 20.5802 9.29874 20.1246 9.75435C19.6689 10.2097 18.9304 10.2092 18.4749 9.75366L17.1663 8.4451V23.5554L18.4749 22.2468C18.9304 21.7913 19.6689 21.7907 20.1246 22.2461C20.5802 22.7017 20.5802 23.4409 20.1246 23.8965L16.8252 27.1959C16.823 27.1981 16.8198 27.1999 16.8176 27.2021C16.8043 27.2151 16.7907 27.2277 16.7769 27.2401C16.7622 27.2532 16.7478 27.2665 16.7327 27.2787C16.7214 27.2878 16.7097 27.2963 16.6981 27.305C16.6782 27.3199 16.658 27.3343 16.6374 27.3478C16.4541 27.4676 16.2354 27.5377 16 27.5377C15.9007 27.5377 15.8048 27.5237 15.7127 27.5004C15.6966 27.4963 15.6804 27.4927 15.6644 27.488C15.5564 27.4555 15.455 27.4082 15.3626 27.3478C15.3494 27.3391 15.3369 27.3294 15.324 27.3202C15.3057 27.3071 15.2875 27.2941 15.2701 27.2801C15.2602 27.2721 15.2508 27.2636 15.2411 27.2552C15.2211 27.238 15.2012 27.2206 15.1824 27.2021C15.1802 27.1999 15.177 27.1981 15.1748 27.1959L11.8754 23.8965C11.4198 23.4409 11.4198 22.7017 11.8754 22.2461C12.3311 21.7907 13.0696 21.7913 13.5251 22.2468L14.8337 23.5554V8.4451L13.5251 9.75366C13.0696 10.2092 12.3311 10.2097 11.8754 9.75435C11.4198 9.29874 11.4198 8.55959 11.8754 8.10398L15.1748 4.8046C15.2285 4.7509 15.2876 4.70275 15.3509 4.66028C15.3693 4.6479 15.3886 4.63697 15.4075 4.62576C15.4226 4.61683 15.4376 4.60777 15.4531 4.59952C15.4674 4.59191 15.482 4.58508 15.4966 4.57811C15.5482 4.55337 15.6014 4.53162 15.6568 4.51458C15.6828 4.5066 15.7091 4.49999 15.7355 4.49386C15.7506 4.49036 15.7658 4.48711 15.7811 4.4842C15.8914 4.46322 16.0039 4.45799 16.1153 4.46901C16.1398 4.47141 16.1638 4.47547 16.1878 4.47936C16.2005 4.48142 16.2132 4.4831 16.2258 4.48558C16.2421 4.48878 16.2581 4.49276 16.2741 4.49663C16.2972 4.5022 16.3204 4.50758 16.3432 4.51458C16.404 4.53328 16.4625 4.55709 16.5186 4.58501C16.5281 4.58973 16.5375 4.59453 16.5469 4.59952C16.5636 4.6084 16.5797 4.61816 16.5959 4.62783C16.6137 4.63843 16.6318 4.64865 16.6491 4.66028C16.7124 4.70275 16.7715 4.7509 16.8252 4.8046L20.1246 8.10398Z',
    );
  }

  private setRotateCursor(angle: number): void {
    this.angle.next(angle);
    this.cursorSvgPath.next(
      'M6.35664 14.0568C6.3575 13.4761 6.82898 13.0046 7.4097 13.0038C7.99145 13.003 8.46286 13.4744 8.46208 14.0561L8.45931 15.5518C11 13.3951 13.4559 12.1997 16.0207 12.1958C18.5719 12.1922 21.0108 13.3689 23.5309 15.4966L23.5337 14.0561C23.5345 13.4754 24.006 13.0039 24.5867 13.0031C25.1683 13.0024 25.6397 13.4739 25.6391 14.0555L25.6336 17.6877C25.7115 18.0293 25.618 18.4019 25.3525 18.6675C25.1448 18.8752 24.8712 18.9777 24.5985 18.9755L24.5805 18.9769L20.7128 18.9817C20.131 18.9826 19.6596 18.5112 19.6605 17.9294C19.6615 17.3488 20.1322 16.8778 20.7128 16.877L21.8902 16.8749C19.7026 15.0909 17.8123 14.2986 16.02 14.3013C14.2288 14.304 12.3365 15.0998 10.1456 16.8873L11.2912 16.8853C11.8729 16.8845 12.3442 17.356 12.3436 17.9376C12.3427 18.5184 11.8712 18.9898 11.2905 18.9907L7.52364 18.9955C7.22017 19.0266 6.90584 18.9273 6.6729 18.6945C6.59435 18.6159 6.53145 18.5277 6.48301 18.4341C6.39926 18.283 6.35084 18.109 6.35111 17.9238L6.35664 14.0568Z',
    );
  }

  private cursorSvgTemplate(path: string, angle: number): string {
    return `
      url("data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000' stroke='%23fff' style='transform: rotate(${angle}deg); transform-origin: center'%3E%3Cpath d='${path}' /%3E%3C/g%3E%3C/svg%3E%0A")
        16 16,
      auto`;
  }
}

export enum CursorType {
  Auto,
  Rotate,
  Resize,
  Move,
}
